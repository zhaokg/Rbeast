#include "abc_000_warning.h"

#include "abc_001_config.h"
#include <math.h>
#include <stdio.h>
#include <string.h>
#include <time.h>
#include <stdio.h>
 
#ifndef ARM64_OS
	#include <immintrin.h> //https://stackoverflow.com/questions/56049110/including-the-correct-intrinsic-header
#endif

#include "abc_datatype.h"
#include "abc_blas_lapack_lib.h"
#include "abc_common.h"
#include "abc_ide_util.h"
#include "abc_pthread.h"
#include "abc_timer.h"
//#include "abc_dir.h"


 
#include "beastv2_io.h"

#if !defined(R_RELEASE)
#include "mrbeast_header.h"
#include "mrbeast_io.h" 
#include "sbmfast.h"
#include "sbmfast_io.h"
#endif

#include "globalvars.h"
#include "abc_vec.h"

#if   R_INTERFACE == 1
	#define IDE_NULL R_NilValue
#elif M_INTERFACE == 1
	#define IDE_NULL mxCreateNumericMatrix(0, 0, mxSINGLE_CLASS, mxREAL)
#endif


#if defined(WIN64_OS) 
/*---------WINDOW-------------------------*/
//extern void DllExport WinMainDemoST(BEAST_OPTIONS_PTR  option);
//extern void DllExport WinMainDemoTrend(BEAST_OPTIONS_PTR  option);
/*---------WINDOW-------------------------*/
#endif


//#include "..\TinyTiff\tinytiffreader.h"

#include "abc_cpu.h"
#include "abc_timer.h"
#include "abc_rand.h"
 
#include "math.h"

#ifndef ARM64_OS
	#include "abc_math_avx.h"
#endif

#define IS_STRING_EQUAL(a, b)  (strcicmp(a, b) == 0)

#if R_INTERFACE==1 &&  defined(MSVC_COMPILER)
	#include "R_ext\Parse.h"
char R_FUNC[] = { 10,10,112,108,111,116,46,98,101,97,115,116,118,52,32,60,45,32,102,117,110,99,116,105,111,110,40,120,44,32,105,110,100,101,120,49,44,32,105,110,100,101,120,50,44,32,46,46,46,41,32,123,10,32,32,35,115,116,97,99,107,111,118,101,114,102,108,111,119,46,99,111,109,47,113,117,101,115,116,105,111,110,115,47,51,57,54,55,48,54,52,54,47,114,45,103,105,116,104,117,98,45,112,97,99,107,97,103,101,45,119,45,100,101,118,116,111,111,108,115,45,119,97,114,110,105,110,103,45,117,110,107,110,111,119,110,45,109,97,99,114,111,45,105,116,101,109,10,32,32,105,102,32,40,109,105,115,115,105,110,103,40,105,110,100,101,120,49,41,41,32,123,105,110,100,101,120,49,32,61,32,49,59,125,59,10,32,32,105,102,32,40,109,105,115,115,105,110,103,40,105,110,100,101,120,50,41,41,32,123,105,110,100,101,120,50,32,61,32,49,59,125,59,10,32,32,10,32,32,105,110,100,101,120,49,32,61,32,49,59,10,32,32,116,105,100,120,32,32,32,61,32,97,116,116,114,105,98,117,116,101,115,40,120,41,36,119,104,105,99,104,84,105,109,101,59,10,32,32,105,102,32,40,105,115,46,110,117,108,108,40,116,105,100,120,41,41,32,123,116,105,100,120,32,61,32,49,59,125,59,10,32,32,10,32,32,104,97,115,83,101,97,115,111,110,32,61,32,33,105,115,46,110,117,108,108,40,120,36,115,101,97,115,111,110,41,32,38,38,32,33,105,115,46,110,117,108,108,40,120,36,115,101,97,115,111,110,36,89,41,59,10,32,32,10,10,32,32,112,108,111,116,66,69,65,83,84,95,83,84,32,60,45,32,102,117,110,99,116,105,111,110,40,120,44,32,105,110,100,101,120,49,44,32,105,110,100,101,120,50,41,32,123,10,32,32,32,32,10,32,32,32,32,116,105,109,101,32,61,32,120,36,116,105,109,101,91,44,32,49,93,59,10,32,32,32,32,116,50,116,32,32,61,32,99,40,116,105,109,101,44,32,114,101,118,40,116,105,109,101,41,41,59,10,32,32,32,32,78,32,32,32,32,61,32,108,101,110,103,116,104,40,116,105,109,101,41,59,10,32,32,32,32,10,32,32,32,32,108,109,32,61,32,48,46,49,59,32,32,32,114,109,32,61,32,48,46,48,50,59,32,32,116,109,32,61,32,48,46,49,59,32,32,98,109,32,61,32,48,46,49,59,32,32,32,109,109,32,32,61,32,48,46,48,56,59,10,32,32,32,32,119,100,32,61,32,40,49,32,45,32,116,109,32,45,32,98,109,32,45,32,109,109,41,32,47,32,50,59,32,32,119,100,49,32,61,32,119,100,32,42,32,48,46,54,59,32,32,119,100,50,32,61,32,119,100,32,42,32,48,46,52,59,10,32,32,32,32,10,32,32,32,32,35,120,49,49,40,41,32,10,32,32,32,32,35,45,45,84,104,101,32,115,101,97,115,111,110,97,108,32,99,111,109,112,111,101,110,116,45,45,45,35,32,10,32,32,32,32,110,68,105,109,32,61,32,108,101,110,103,116,104,40,100,105,109,40,120,36,116,114,101,110,100,36,89,41,41,59,10,32,32,32,32,105,102,32,40,110,68,105,109,32,61,61,32,50,41,32,123,10,32,32,32,32,32,32,89,32,61,32,120,36,115,101,97,115,111,110,36,89,91,44,32,105,110,100,101,120,49,93,59,10,32,32,32,32,32,32,83,68,32,61,32,120,36,115,101,97,115,111,110,36,83,68,91,44,32,105,110,100,101,120,49,93,59,10,32,32,32,32,32,32,83,68,91,105,115,46,110,97,110,40,83,68,41,93,32,61,32,48,59,32,32,32,83,68,91,105,115,46,110,97,40,83,68,41,93,32,61,32,48,59,10,32,32,32,32,32,32,89,83,68,32,61,32,99,40,89,32,45,32,83,68,44,32,114,101,118,40,89,32,43,32,83,68,41,41,59,10,32,32,32,32,32,32,80,32,61,32,120,36,115,101,97,115,111,110,36,99,112,79,99,99,80,114,91,44,32,105,110,100,101,120,49,93,59,10,32,32,32,32,32,32,99,112,32,61,32,120,36,115,101,97,115,111,110,36,99,112,91,44,32,105,110,100,101,120,49,93,59,10,32,32,32,32,32,32,99,112,32,61,32,99,112,91,33,105,115,46,110,97,40,99,112,41,93,59,10,32,32,32,32,32,32,110,99,112,32,61,32,108,101,110,103,116,104,40,99,112,41,59,10,32,32,32,32,125,10,32,32,32,32,101,108,115,101,32,123,10,32,32,32,32,32,32,10,32,32,32,32,125,59,10,32,32,32,32,10,32,32,32,32,10,32,32,32,32,112,97,114,40,112,108,116,32,61,32,99,40,108,109,44,32,49,32,45,32,114,109,44,32,49,32,45,32,116,109,32,45,32,119,100,49,44,32,49,32,45,32,116,109,41,41,59,10,32,32,32,32,112,108,111,116,40,116,50,116,44,32,89,83,68,44,32,116,121,112,101,32,61,32,39,110,39,44,32,97,110,110,32,61,32,70,44,32,120,97,120,116,32,61,32,39,110,39,44,32,121,97,120,116,32,61,32,39,110,39,41,59,10,32,32,32,32,114,101,99,116,40,112,97,114,40,39,117,115,114,39,41,91,49,93,44,32,112,97,114,40,39,117,115,114,39,41,91,51,93,44,32,112,97,114,40,39,117,115,114,39,41,91,50,93,44,32,112,97,114,40,39,117,115,114,39,41,91,52,93,44,32,99,111,108,32,61,32,39,115,107,121,98,108,117,101,39,41,59,10,32,32,32,32,97,120,105,115,40,49,44,32,108,97,98,101,108,115,32,61,32,70,44,32,116,99,108,32,61,32,48,46,50,53,41,59,10,32,32,32,32,97,120,105,115,40,50,44,32,108,97,98,101,108,115,32,61,32,78,85,76,76,44,32,112,97,100,106,32,61,32,49,46,53,44,32,116,99,108,32,61,32,48,46,50,53,41,59,10,32,32,32,32,116,105,116,108,101,40,121,108,97,98,32,61,32,39,83,101,97,115,111,110,97,108,39,44,32,109,103,112,32,61,32,99,40,49,46,50,44,32,48,44,32,48,41,41,59,10,32,32,32,32,112,111,108,121,103,111,110,40,116,50,116,44,32,89,83,68,44,32,99,111,108,32,61,32,39,35,66,52,66,52,66,52,39,44,32,98,111,114,100,101,114,32,61,32,39,35,56,52,56,52,56,52,39,41,59,10,32,32,32,32,35,112,97,114,40,110,101,119,32,61,32,84,82,85,69,41,59,92,110,10,32,32,32,32,112,111,105,110,116,115,40,116,105,109,101,44,32,89,44,32,116,121,112,101,32,61,32,39,108,39,44,32,99,111,108,32,61,32,39,114,101,100,39,44,32,120,108,97,98,32,61,32,78,85,76,76,44,32,108,119,100,32,61,32,50,44,32,97,110,110,32,61,32,70,65,76,83,69,44,32,98,103,32,61,32,39,114,101,100,39,41,59,10,32,32,32,32,35,116,101,120,116,40,109,101,97,110,40,116,105,109,101,41,32,47,32,50,46,48,44,32,39,78,79,32,83,69,65,83,79,78,65,76,32,67,79,77,80,79,78,69,84,46,73,71,78,79,82,69,32,84,72,73,83,32,80,79,76,79,84,39,41,59,92,110,10,32,32,32,32,115,116,114,61,112,97,115,116,101,40,97,115,46,99,104,97,114,97,99,116,101,114,40,97,115,46,105,110,116,101,103,101,114,40,120,36,115,101,97,115,111,110,36,110,99,112,42,49,48,48,41,47,49,48,48,41,44,32,32,97,115,46,99,104,97,114,97,99,116,101,114,40,97,115,46,105,110,116,101,103,101,114,40,120,36,116,114,101,110,100,36,110,99,112,42,49,48,48,41,47,49,48,48,41,41,59,10,32,32,32,32,116,105,116,108,101,40,109,97,105,110,32,61,32,115,116,114,41,59,10,32,32,32,32,10,32,32,32,32,105,102,32,40,110,99,112,32,62,32,48,41,32,123,10,32,32,32,32,32,32,102,111,114,32,40,105,32,105,110,32,49,32,58,32,110,99,112,41,32,123,10,32,32,32,32,32,32,32,32,99,112,116,32,61,32,99,112,91,105,93,59,10,32,32,32,32,32,32,32,32,112,111,105,110,116,115,40,99,40,99,112,116,44,32,99,112,116,41,44,32,99,40,112,97,114,40,39,117,115,114,39,41,91,51,93,44,32,112,97,114,40,39,117,115,114,39,41,91,52,93,41,44,10,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,116,121,112,101,32,61,32,39,108,39,44,32,108,116,121,32,61,32,39,100,97,115,104,101,100,39,44,32,99,111,108,32,61,32,39,103,114,101,121,49,48,39,44,32,120,108,97,98,32,61,32,78,85,76,76,44,32,108,119,100,32,61,32,50,44,10,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,110,110,32,61,32,70,65,76,83,69,44,32,98,103,32,61,32,39,103,114,101,121,49,48,39,41,59,10,32,32,32,32,32,32,125,10,32,32,32,32,125,59,10,32,32,32,32,10,32,32,32,32,112,97,114,40,112,108,116,32,61,32,99,40,108,109,44,32,49,32,45,32,114,109,44,32,49,32,45,32,116,109,32,45,32,119,100,44,32,49,32,45,32,116,109,32,45,32,119,100,49,41,44,32,110,101,119,32,61,32,84,82,85,69,41,59,10,32,32,32,32,112,108,111,116,40,116,105,109,101,44,32,80,44,32,116,121,112,101,32,61,32,39,110,39,44,32,97,110,110,32,61,32,70,44,32,120,97,120,116,32,61,32,39,110,39,44,32,121,97,120,116,32,61,32,39,110,39,41,59,10,32,32,32,32,114,101,99,116,40,112,97,114,40,39,117,115,114,39,41,91,49,93,44,32,112,97,114,40,39,117,115,114,39,41,91,51,93,44,32,112,97,114,40,39,117,115,114,39,41,91,50,93,44,32,112,97,114,40,39,117,115,114,39,41,91,52,93,44,32,99,111,108,32,61,32,39,115,107,121,98,108,117,101,39,41,59,10,32,32,32,32,112,97,114,40,110,101,119,32,61,32,84,82,85,69,41,59,10,32,32,32,32,112,108,111,116,40,116,105,109,101,44,32,80,44,32,120,108,97,98,32,61,32,39,39,44,32,121,108,97,98,32,61,32,39,39,44,32,116,121,112,101,32,61,32,39,108,39,44,32,99,111,108,32,61,32,39,98,108,97,99,107,39,44,32,108,119,100,32,61,32,50,44,32,120,97,120,116,32,61,32,39,110,39,44,32,121,97,120,116,32,61,32,39,110,39,41,59,10,32,32,32,32,97,120,105,115,40,49,44,32,108,97,98,101,108,115,32,61,32,78,85,76,76,44,32,112,97,100,106,32,61,32,45,49,46,53,44,32,116,99,108,32,61,32,48,46,50,53,41,59,10,32,32,32,32,97,120,105,115,40,50,44,32,108,97,98,101,108,115,32,61,32,78,85,76,76,44,32,112,97,100,106,32,61,32,49,46,53,44,32,116,99,108,32,61,32,48,46,50,53,41,59,10,32,32,32,32,116,105,116,108,101,40,120,108,97,98,32,61,32,39,84,105,109,101,39,44,32,121,108,97,98,32,61,32,39,80,114,111,98,39,44,32,109,103,112,32,61,32,99,40,49,46,50,44,32,49,46,50,44,32,48,41,41,59,10,32,32,32,32,116,101,120,116,40,109,101,97,110,40,116,105,109,101,41,32,47,32,50,46,48,44,32,39,78,79,32,83,69,65,83,79,78,65,76,32,67,79,77,80,79,78,69,84,46,73,71,78,79,82,69,32,84,72,73,83,32,80,79,76,79,84,39,41,59,10,32,32,32,32,10,32,32,32,32,10,32,32,32,32,35,45,45,84,104,101,32,116,114,101,110,100,32,99,111,109,112,111,101,110,116,45,45,45,35,92,110,10,32,32,32,32,10,32,32,32,32,105,102,32,40,110,68,105,109,32,61,61,32,50,41,32,123,10,32,32,32,32,32,32,89,32,61,32,120,36,116,114,101,110,100,36,89,91,44,32,105,110,100,101,120,49,93,59,10,32,32,32,32,32,32,83,68,32,61,32,120,36,116,114,101,110,100,36,83,68,91,44,32,105,110,100,101,120,49,93,59,10,32,32,32,32,32,32,83,68,91,105,115,46,110,97,110,40,83,68,41,93,32,61,32,48,59,32,32,32,83,68,91,105,115,46,110,97,40,83,68,41,93,32,61,32,48,59,10,32,32,32,32,32,32,89,83,68,32,61,32,99,40,89,32,45,32,83,68,44,32,114,101,118,40,89,32,43,32,83,68,41,41,59,10,32,32,32,32,32,32,80,32,61,32,120,36,116,114,101,110,100,36,99,112,79,99,99,80,114,91,44,32,105,110,100,101,120,49,93,59,10,32,32,32,32,32,32,99,112,32,61,32,120,36,116,114,101,110,100,36,99,112,91,44,32,105,110,100,101,120,49,93,59,10,32,32,32,32,32,32,99,112,32,61,32,99,112,91,33,105,115,46,110,97,40,99,112,41,93,59,10,32,32,32,32,32,32,110,99,112,32,61,32,108,101,110,103,116,104,40,99,112,41,59,10,32,32,32,32,125,10,32,32,32,32,101,108,115,101,32,123,10,32,32,32,32,32,32,10,32,32,32,32,125,59,10,32,32,32,32,10,32,32,32,32,112,97,114,40,112,108,116,32,61,32,99,40,108,109,44,32,49,32,45,32,114,109,44,32,49,32,45,32,116,109,32,45,32,119,100,32,45,32,109,109,32,45,32,119,100,49,44,32,49,32,45,32,116,109,32,45,32,119,100,32,45,32,109,109,41,44,32,110,101,119,32,61,32,84,82,85,69,41,59,10,32,32,32,32,112,108,111,116,40,116,50,116,44,32,89,83,68,44,32,116,121,112,101,32,61,32,39,110,39,44,32,97,110,110,32,61,32,70,44,32,120,97,120,116,32,61,32,39,110,39,44,32,121,97,120,116,32,61,32,39,110,39,41,59,10,32,32,32,32,114,101,99,116,40,112,97,114,40,39,117,115,114,39,41,91,49,93,44,32,112,97,114,40,39,117,115,114,39,41,91,51,93,44,32,112,97,114,40,39,117,115,114,39,41,91,50,93,44,32,112,97,114,40,39,117,115,114,39,41,91,52,93,44,32,99,111,108,32,61,32,39,100,97,114,107,111,108,105,118,101,103,114,101,101,110,51,39,41,59,10,32,32,32,32,97,120,105,115,40,49,44,32,108,97,98,101,108,115,32,61,32,70,44,32,116,99,108,32,61,32,48,46,50,53,41,59,10,32,32,32,32,97,120,105,115,40,50,44,32,108,97,98,101,108,115,32,61,32,78,85,76,76,44,32,112,97,100,106,32,61,32,49,46,53,44,32,116,99,108,32,61,32,48,46,50,53,41,59,10,32,32,32,32,116,105,116,108,101,40,121,108,97,98,32,61,32,39,84,114,101,110,100,39,44,32,109,103,112,32,61,32,99,40,49,46,50,44,32,48,44,32,48,41,41,59,10,32,32,32,32,112,111,108,121,103,111,110,40,116,50,116,44,32,89,83,68,44,32,99,111,108,32,61,32,39,35,66,52,66,52,66,52,39,44,32,98,111,114,100,101,114,32,61,32,39,35,56,52,56,52,56,52,39,41,59,32,10,32,32,32,32,35,112,97,114,40,110,101,119,32,61,32,84,82,85,69,41,92,110,10,32,32,32,32,112,111,105,110,116,115,40,116,105,109,101,44,32,89,44,32,116,121,112,101,32,61,32,39,108,39,44,32,99,111,108,32,61,32,39,114,101,100,39,44,32,120,108,97,98,32,61,32,78,85,76,76,44,32,108,119,100,32,61,32,50,44,32,97,110,110,32,61,32,70,65,76,83,69,44,32,98,103,32,61,32,39,114,101,100,39,41,59,10,32,32,32,32,10,32,32,32,32,105,102,32,40,110,99,112,32,62,32,48,41,32,123,10,32,32,32,32,32,32,102,111,114,32,40,105,32,105,110,32,49,32,58,32,110,99,112,41,32,123,10,32,32,32,32,32,32,32,32,99,112,116,32,61,32,99,112,91,105,93,59,10,32,32,32,32,32,32,32,32,112,111,105,110,116,115,40,99,40,99,112,116,44,32,99,112,116,41,44,32,99,40,112,97,114,40,39,117,115,114,39,41,91,51,93,44,32,112,97,114,40,39,117,115,114,39,41,91,52,93,41,44,10,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,116,121,112,101,32,61,32,39,108,39,44,32,108,116,121,32,61,32,39,100,97,115,104,101,100,39,44,32,99,111,108,32,61,32,39,103,114,101,121,49,48,39,44,32,120,108,97,98,32,61,32,78,85,76,76,44,32,108,119,100,32,61,32,50,44,10,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,110,110,32,61,32,70,65,76,83,69,44,32,98,103,32,61,32,39,103,114,101,121,49,48,39,41,59,10,32,32,32,32,32,32,125,10,32,32,32,32,125,59,10,32,32,32,32,10,32,32,32,32,10,32,32,32,32,112,97,114,40,112,108,116,32,61,32,99,40,108,109,44,32,49,32,45,32,114,109,44,32,98,109,44,32,98,109,32,43,32,119,100,50,41,44,32,110,101,119,32,61,32,84,82,85,69,41,59,10,32,32,32,32,112,108,111,116,40,116,105,109,101,44,32,80,44,32,116,121,112,101,32,61,32,39,110,39,44,32,97,110,110,32,61,32,70,44,32,120,97,120,116,32,61,32,39,110,39,44,32,121,97,120,116,32,61,32,39,110,39,41,59,10,32,32,32,32,114,101,99,116,40,112,97,114,40,39,117,115,114,39,41,91,49,93,44,32,112,97,114,40,39,117,115,114,39,41,91,51,93,44,32,112,97,114,40,39,117,115,114,39,41,91,50,93,44,32,112,97,114,40,39,117,115,114,39,41,91,52,93,44,32,99,111,108,32,61,32,39,100,97,114,107,111,108,105,118,101,103,114,101,101,110,51,39,41,59,10,32,32,32,32,112,97,114,40,110,101,119,32,61,32,84,82,85,69,41,59,10,32,32,32,32,112,108,111,116,40,116,105,109,101,44,32,80,44,32,120,108,97,98,32,61,32,39,39,44,121,108,97,98,32,61,32,39,39,44,32,116,121,112,101,32,61,32,39,108,39,44,32,99,111,108,32,61,32,39,98,108,97,99,107,39,44,32,108,119,100,32,61,32,50,44,32,120,97,120,116,32,61,32,39,110,39,44,32,121,97,120,116,32,61,32,39,110,39,41,59,10,32,32,32,32,97,120,105,115,40,49,44,32,108,97,98,101,108,115,32,61,32,78,85,76,76,44,32,112,97,100,106,32,61,32,45,49,46,53,44,32,116,99,108,32,61,32,48,46,50,53,41,59,10,32,32,32,32,97,120,105,115,40,50,44,32,108,97,98,101,108,115,32,61,32,78,85,76,76,44,32,112,97,100,106,32,61,32,49,46,53,44,32,116,99,108,32,61,32,48,46,50,53,41,59,10,32,32,32,32,116,105,116,108,101,40,120,108,97,98,32,61,32,39,84,105,109,101,39,44,32,121,108,97,98,32,61,32,39,80,114,111,98,39,44,32,109,103,112,32,61,32,99,40,49,46,50,44,32,49,46,50,44,32,48,41,41,59,10,32,32,125,59,10,32,32,10,32,32,10,32,32,112,108,111,116,66,69,65,83,84,95,84,32,60,45,32,102,117,110,99,116,105,111,110,40,120,44,32,105,110,100,101,120,49,44,32,105,110,100,101,120,50,41,32,123,10,32,32,32,32,10,32,32,32,32,116,105,109,101,32,61,32,120,36,116,105,109,101,91,44,32,49,93,59,10,32,32,32,32,116,50,116,32,32,61,32,99,40,116,105,109,101,44,32,114,101,118,40,116,105,109,101,41,41,59,10,32,32,32,32,78,32,32,32,32,61,32,108,101,110,103,116,104,40,116,105,109,101,41,59,10,32,32,32,32,10,32,32,32,32,108,109,32,61,32,48,46,49,59,32,32,32,114,109,32,61,32,48,46,48,50,59,32,32,116,109,32,61,32,48,46,49,59,32,32,98,109,32,61,32,48,46,49,59,32,32,32,109,109,32,32,61,32,48,46,48,48,59,10,32,32,32,32,119,100,32,61,32,40,49,45,116,109,45,98,109,45,109,109,41,32,59,32,32,119,100,49,32,61,32,119,100,32,42,32,48,46,54,59,32,32,119,100,50,32,61,32,119,100,32,42,32,48,46,52,59,32,35,77,111,100,102,105,101,100,32,102,111,114,32,116,114,101,110,100,10,32,32,32,32,10,32,32,32,32,35,120,49,49,40,41,32,10,32,32,32,32,110,68,105,109,32,61,32,108,101,110,103,116,104,40,100,105,109,40,120,36,116,114,101,110,100,36,89,41,41,59,10,32,32,32,32,35,45,45,84,104,101,32,116,114,101,110,100,32,99,111,109,112,111,101,110,116,45,45,45,35,92,110,10,32,32,32,32,105,102,32,40,110,68,105,109,32,61,61,32,50,41,32,123,10,32,32,32,32,32,32,89,32,61,32,120,36,116,114,101,110,100,36,89,91,44,32,105,110,100,101,120,49,93,59,10,32,32,32,32,32,32,83,68,32,61,32,120,36,116,114,101,110,100,36,83,68,91,44,32,105,110,100,101,120,49,93,59,10,32,32,32,32,32,32,83,68,91,105,115,46,110,97,110,40,83,68,41,93,32,61,32,48,59,32,32,32,83,68,91,105,115,46,110,97,40,83,68,41,93,32,61,32,48,59,10,32,32,32,32,32,32,89,83,68,32,61,32,99,40,89,32,45,32,83,68,44,32,114,101,118,40,89,32,43,32,83,68,41,41,59,10,32,32,32,32,32,32,80,32,61,32,120,36,116,114,101,110,100,36,99,112,79,99,99,80,114,91,44,32,105,110,100,101,120,49,93,59,10,32,32,32,32,32,32,99,112,32,61,32,120,36,116,114,101,110,100,36,99,112,91,44,32,105,110,100,101,120,49,93,59,10,32,32,32,32,32,32,99,112,32,61,32,99,112,91,33,105,115,46,110,97,40,99,112,41,93,59,10,32,32,32,32,32,32,110,99,112,32,61,32,108,101,110,103,116,104,40,99,112,41,59,10,32,32,32,32,125,32,101,108,115,101,32,123,10,32,32,32,32,32,32,10,32,32,32,32,125,59,10,32,32,32,32,10,32,32,32,32,35,99,40,108,101,102,116,44,32,114,105,103,104,116,44,32,98,111,116,44,32,116,111,112,41,10,32,32,32,32,112,97,114,40,112,108,116,32,61,32,99,40,108,109,44,32,49,32,45,32,114,109,44,32,98,109,43,109,109,43,119,100,50,44,32,49,32,45,32,116,109,41,41,59,32,35,77,111,100,105,102,105,101,100,32,102,111,114,32,116,114,101,110,100,10,32,32,32,32,35,112,97,114,40,112,108,116,32,61,32,99,40,108,109,44,32,49,32,45,32,114,109,44,32,98,109,43,109,109,43,119,100,50,44,32,49,32,45,32,116,109,41,44,32,110,101,119,32,61,32,84,82,85,69,41,59,32,35,77,111,100,105,102,105,101,100,32,102,111,114,32,116,114,101,110,100,10,32,32,32,32,112,108,111,116,40,116,50,116,44,32,89,83,68,44,32,116,121,112,101,32,61,32,39,110,39,44,32,97,110,110,32,61,32,70,44,32,120,97,120,116,32,61,32,39,110,39,44,32,121,97,120,116,32,61,32,39,110,39,41,59,10,32,32,32,32,114,101,99,116,40,112,97,114,40,39,117,115,114,39,41,91,49,93,44,32,112,97,114,40,39,117,115,114,39,41,91,51,93,44,32,112,97,114,40,39,117,115,114,39,41,91,50,93,44,32,112,97,114,40,39,117,115,114,39,41,91,52,93,44,32,99,111,108,32,61,32,39,100,97,114,107,111,108,105,118,101,103,114,101,101,110,51,39,41,59,10,32,32,32,32,97,120,105,115,40,49,44,32,108,97,98,101,108,115,32,61,32,70,44,32,116,99,108,32,61,32,48,46,50,53,41,59,10,32,32,32,32,97,120,105,115,40,50,44,32,108,97,98,101,108,115,32,61,32,78,85,76,76,44,32,112,97,100,106,32,61,32,49,46,53,44,32,116,99,108,32,61,32,48,46,50,53,41,59,10,32,32,32,32,116,105,116,108,101,40,121,108,97,98,32,61,32,39,84,114,101,110,100,39,44,32,109,103,112,32,61,32,99,40,49,46,50,44,32,48,44,32,48,41,41,59,10,32,32,32,32,112,111,108,121,103,111,110,40,116,50,116,44,32,89,83,68,44,32,99,111,108,32,61,32,39,35,66,52,66,52,66,52,39,44,32,98,111,114,100,101,114,32,61,32,39,35,56,52,56,52,56,52,39,41,59,32,10,32,32,32,32,35,112,97,114,40,110,101,119,32,61,32,84,82,85,69,41,92,110,10,32,32,32,32,112,111,105,110,116,115,40,116,105,109,101,44,32,89,44,32,116,121,112,101,32,61,32,39,108,39,44,32,99,111,108,32,61,32,39,114,101,100,39,44,32,120,108,97,98,32,61,32,78,85,76,76,44,32,108,119,100,32,61,32,50,44,32,97,110,110,32,61,32,70,65,76,83,69,44,32,98,103,32,61,32,39,114,101,100,39,41,59,10,32,32,32,32,10,32,32,32,32,105,102,32,40,110,99,112,32,62,32,48,41,32,123,10,32,32,32,32,32,32,102,111,114,32,40,105,32,105,110,32,49,32,58,32,110,99,112,41,32,123,10,32,32,32,32,32,32,32,32,99,112,116,32,61,32,99,112,91,105,93,59,10,32,32,32,32,32,32,32,32,112,111,105,110,116,115,40,99,40,99,112,116,44,32,99,112,116,41,44,32,99,40,112,97,114,40,39,117,115,114,39,41,91,51,93,44,32,112,97,114,40,39,117,115,114,39,41,91,52,93,41,44,10,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,116,121,112,101,32,61,32,39,108,39,44,32,108,116,121,32,61,32,39,100,97,115,104,101,100,39,44,32,99,111,108,32,61,32,39,103,114,101,121,49,48,39,44,32,120,108,97,98,32,61,32,78,85,76,76,44,32,108,119,100,32,61,32,50,44,10,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,110,110,32,61,32,70,65,76,83,69,44,32,98,103,32,61,32,39,103,114,101,121,49,48,39,41,59,10,32,32,32,32,32,32,125,10,32,32,32,32,125,59,10,32,32,32,32,10,32,32,32,32,10,32,32,32,32,112,97,114,40,112,108,116,32,61,32,99,40,108,109,44,32,49,32,45,32,114,109,44,32,98,109,44,32,98,109,43,119,100,50,41,44,32,110,101,119,32,61,32,84,82,85,69,41,59,10,32,32,32,32,112,108,111,116,40,116,105,109,101,44,32,80,44,32,116,121,112,101,32,61,32,39,110,39,44,32,97,110,110,32,61,32,70,44,32,120,97,120,116,32,61,32,39,110,39,44,32,121,97,120,116,32,61,32,39,110,39,41,59,10,32,32,32,32,114,101,99,116,40,112,97,114,40,39,117,115,114,39,41,91,49,93,44,32,112,97,114,40,39,117,115,114,39,41,91,51,93,44,32,112,97,114,40,39,117,115,114,39,41,91,50,93,44,32,112,97,114,40,39,117,115,114,39,41,91,52,93,44,32,99,111,108,32,61,32,39,100,97,114,107,111,108,105,118,101,103,114,101,101,110,51,39,41,59,10,32,32,32,32,112,97,114,40,110,101,119,32,61,32,84,82,85,69,41,59,10,32,32,32,32,112,108,111,116,40,116,105,109,101,44,32,80,44,32,120,108,97,98,32,61,32,39,39,44,121,108,97,98,32,61,32,39,39,44,32,116,121,112,101,32,61,32,39,108,39,44,32,99,111,108,32,61,32,39,98,108,97,99,107,39,44,32,108,119,100,32,61,32,50,44,32,120,97,120,116,32,61,32,39,110,39,44,32,121,97,120,116,32,61,32,39,110,39,41,59,10,32,32,32,32,97,120,105,115,40,49,44,32,108,97,98,101,108,115,32,61,32,78,85,76,76,44,32,112,97,100,106,32,61,32,45,49,46,53,44,32,116,99,108,32,61,32,48,46,50,53,41,59,10,32,32,32,32,97,120,105,115,40,50,44,32,108,97,98,101,108,115,32,61,32,78,85,76,76,44,32,112,97,100,106,32,61,32,49,46,53,44,32,116,99,108,32,61,32,48,46,50,53,41,59,10,32,32,32,32,116,105,116,108,101,40,120,108,97,98,32,61,32,39,84,105,109,101,39,44,32,121,108,97,98,32,61,32,39,80,114,111,98,39,44,32,109,103,112,32,61,32,99,40,49,46,50,44,32,49,46,50,44,32,48,41,41,59,10,32,32,125,59,32,32,10,32,32,10,32,32,10,32,32,105,102,40,104,97,115,83,101,97,115,111,110,41,123,10,32,32,32,32,112,108,111,116,66,69,65,83,84,95,83,84,40,120,44,105,110,100,101,120,49,44,105,110,100,101,120,50,41,59,10,32,32,125,32,101,108,115,101,123,10,32,32,32,32,112,108,111,116,66,69,65,83,84,95,84,40,120,44,105,110,100,101,120,49,44,105,110,100,101,120,50,41,59,10,32,32,125,10,10,125,59,10,10 };
#endif

static void SetupRoutinesByCPU() {

	if (IS_CPU_INSTRUCTON_SET) return;

	 r_printf("On the first run, check the CPU instruction set ... \n\n");
	 struct cpu_x86 cpuinfo;
	 detect_host(&cpuinfo);
	 printinfo(&cpuinfo);
	 
	 i386_cpuid_caches();
#if !defined(SOLARIS_COMPILER) && defined(TARGET_64) && !defined(ARM64_OS)
		 if (cpuinfo.HW_AVX512_F /*Foundation*/ && cpuinfo.HW_AVX512_BW && cpuinfo.HW_AVX512_DQ && cpuinfo.HW_AVX512_VL) {
			 SetupVectorFunction_AVX512();
			 SetupPCG_AVX512();
			 r_printf("CPU checking result: The AVX512-enabled library is used ... \n\n");
		 }
		 else if (cpuinfo.HW_AVX &&cpuinfo.HW_AVX2 && cpuinfo.HW_FMA3) {
			 SetupVectorFunction_AVX2();
			 SetupPCG_AVX2();
			 r_printf("CPU checking result: The AVX2-enabled library is used ...\n\n");
		 }
		 else {
			 SetupVectorFunction_Generic();
			 SetupPCG_GENERIC();
			 r_printf("CPU checking result: No AVX2/AVX512 is supported and the default library is used ...\n\n");
		 }
	#else
		 SetupVectorFunction_Generic();
		 SetupPCG_GENERIC();
		 r_printf("No AVX2 is supported and the default library is used ...");	
	#endif
		 


	IS_CPU_INSTRUCTON_SET = 1;
}

 
void TestCode() {

	F32 a[115500];
	F32 b[115500];
	F32 c[115500];
	F32 c1[5500];
	F32 c2[5500];
	I08 c3[5500];
	I32 N = 100;
	I32 M = 60000;

	/*
	// Compiled code should not call entry points which might terminate R nor
    // write to stdout/stderr instead of to the console, nor use Fortran I/O
    // nor system RNGs.
	srand(23232);
	for (int i = 0; i < 115500; i++) {		
		a[i] = (rand() % 5000) / 5000.;
		b[i] = (rand() % 5000) / 5000.;
		c[i] = (rand() % 5000) / 5000.;
	}	 
	 */

	/*
	for (int i = 0; i <=1; ++i) {
		int N = 9000 + i;

		SetupVectorFunction_AVX2();
		memcpy(a, c, sizeof(F32) * N);		
		F32 x = f32_sum(a, N);
		f32_maxidx(a, N, &x);
		/////////////////////////////////////
		SetupVectorFunction_AVX512();
		//f32_fill_val(1.0, a, N);
		memcpy(a, c, sizeof(F32) * N);		
		F32 y = f32_sum(a, N);
		f32_maxidx(a, N, &y);

		r_printf("AX2 :%f  a521: %f d:%f\n", x, y,x-y);
	
	}
	*/

	//r_cblas_sgemm(CblasColMajor, CblasTrans, CblasNoTrans, k1_new - 1, K_newTerm, N, 1.0f, Xt_mars, Npad, Xnewterm, Npad, 0.f, GlobalMEMBuf_1st, k1_new - 1);
	//void f32_gemm_XtY2x2(int M, int N, int K, F32PTR A, int lda, F32PTR B, int ldb, F32PTR C, int ldc);
	//void f32_gemm_XtY2x1(int M, int N, int K, F32PTR A, int lda, F32PTR B, int ldb, F32PTR C, int ldc);
	//void f32_gemm_XY2x1(int M, int N, int K, F32PTR A, int lda, F32PTR B, int ldb, F32PTR C, int ldc);
	//void f32_gemm_XY2x2(int M, int N, int K, F32PTR A, int lda, F32PTR B, int ldb, F32PTR C, int ldc);
	//void f32_gemm_XYt2x1(int M, int N, int K, F32PTR A, int lda, F32PTR B, int ldb, F32PTR C, int ldc);
	//void f32_gemm_XtYt2x2(int M, int N, int K, F32PTR A, int lda, F32PTR B, int ldb, F32PTR C, int ldc);
	void avx2_f32_gemv_Xy1x1(int N, int K, F32PTR X, int lda, F32PTR y, F32PTR C);
	void avx2_f32_gemm_XY1x2(int M, int N, int K, F32PTR A, int lda, F32PTR B, int ldb, F32PTR C, int ldc);	
	I32  gen_f32_scatter_vec_byindex(F32PTR  x, I32PTR indices, F32PTR values, int N);
	I32  avx2_f32_scatter_vec_byindex(F32PTR  x, I32PTR indices, F32PTR values, int N);
	void avx2_f32_gatherVec_scatterVal_byindex(F32PTR  x, I32PTR indices, F32PTR values, F32 newValue, int N);
	void gen_f32_gatherVec_scatterVal_byindex(F32PTR  x, I32PTR indices, F32PTR values, F32 newValue, int N);

	void gen_f32_gather2Vec_scatterVal_byindex(F32PTR  x, F32PTR  y, I32PTR indices, F32PTR values, F32 newValue, int N);
	void avx2_f32_gather2Vec_scatterVal_byindex(F32PTR  x, F32PTR  y, I32PTR indices, F32PTR values, F32 newValue, int N);

	f32_findindex(a, c1, 10, 1000, CMP_LT);
	void avx2_f32_memcpy(const I32PTR dst, const I32PTR src, const int N);

	F32 res = 10;
	I32 idx = 0;
	for (int i = 0; i <= 100; i++) {
		//r_cblas_sgemm(CblasColMajor, CblasTrans, CblasNoTrans, 20, 20, 50, 1.0f, a, 50, b, 50, 0., c, 20);
		//f32_gemm_XtY2x1(10, 10, 200, a, 200, b, 200, c, 10);
		//r_cblas_sgemm(CblasColMajor, CblasNoTrans, CblasNoTrans, 10, 10, 200, 1.0f, a, 10, b, 200, 0., c, 10);

		//f32_gemm_XY2x2(10, 10, 200, a, 10, b, 200, c, 10);

		//r_cblas_sgemm(CblasColMajor, CblasNoTrans, CblasTrans, 10, 10, 200, 1.0f, a, 10, b, 10, 0., c1, 10);

		//r_cblas_sgemv(CblasColMajor, CblasNoTrans, 200, 10, 1.f, a, 200, b, 1L, 0.0f, c1, 1L);;

		//f32_dot(a, b, 1000);
		//r_cblas_sgemv(CblasColMajor, CblasTrans, 200,20, 1., a,200,b, 1L, 0.f, c, 1);
		//idx= avx2_f32_minidx(b, 5000, &res);


		memcpy(a, b, sizeof(F32) * 10000);
	}

	tic();
	for (int i = 0; i <= M; i++) {
		//r_cblas_sgemm(CblasColMajor, CblasTrans, CblasNoTrans, 20, 10 ,300, 1.0f, a, 300, b, 300, 0., c1, 20);
		//f32_gemm_XtY2x1(10, 10, 500, a, 500, b, 500, c, 10);

		//r_cblas_sgemm(CblasColMajor, CblasNoTrans, CblasNoTrans, 11, 11, 8 * 20, 1.0f, a, 11, b, 8 * 20, 0., c1, 11);
		//f32_gemm_XY2x2(5, 5, 200, a, 5, b, 200, c, 5);

		//r_cblas_sgemm(CblasColMajor, CblasNoTrans, CblasTrans, 10, 10, 200, 1.0f, a, 10, b, 10, 0., c1, 10);
		//r_cblas_sgemm(CblasColMajor, CblasTrans, CblasTrans, 10, 10, 200, 1.0f, a, 200, b, 10, 0., c1, 10);

		//r_cblas_sgemv(CblasColMajor, CblasNoTrans, 600, 20, 1.f, a, 600, b, 1L, 0.0f, c1, 1L);

		//f32_seq(c1, 0, 0.2, 100);


		// gen_f32_findindex_le(a, c1, .1, 1000);		 
		//avx2_f32_scatter_vec_byindex(a, c1, b, 200);

		//avx2_f32_gather2Vec_scatterVal_byindex(a,c2, c1, b, 0.2, 201);

		//res=f32_dot(a, b, 1000);
		//r_cblas_sgemv(CblasColMajor, CblasTrans, 200, 20, 1., a, 200, b, 1L, 0.f, c, 1);
		//idx = avx2_f32_minidx(b, 5000, &res);

		memcpy(a, b, sizeof(F32) * 10000);

	}
	I64 t1 = toc();


	/***************************************************/
   // Another alg
   /***************************************************/
	for (int i = 0; i <= 100; i++) {
		//avx2_f32_gemm_XtY2x2(20, 20, 300, a, 300, b, 300, c2, 20);

		//f32_gemm_XY2x1(5, 5, 200, a, 5, b, 200, c, 5);
		//f32_gemm_XYt2x1(10, 10, 200, a, 10, b, 10, c2, 10);
		int m = 1000;
		int r = 1;
		//F77__CALL(RSDOT)(&m, a, &r, b, &r);
		//idx = f32_minidx(b, 5000, &res);

		//avx2_f32_gemv_Xb(200, 10, a, 200, b, c2);
		//avx2_f32_memcpy(a, b,   10000);
	}
	tic();
	for (int i = 0; i <= M; i++) {
		//avx2_f32_gemm_XtY2x2(20, 10, 300, a, 300, b, 300, c2, 20);
		//f32_gemm_XtY2x2(11, 11, 201, a, 201, b, 201, c2, 11);
		//f32_gemm_XY2x2(11, 11, 8*20, a, 11, b, 8 * 20, c2, 11);

		//f32_gemm_XYt2x1(10, 10, 200, a, 10, b, 10, c2, 10);
		//f32_gemm_XtYt2x2(10, 10, 200, a, 200, b, 10, c2, 10);

		// f32_gemv_Xb(600, 20, a, 600, b, c2);


		//avx2_f32_gemm_XtY2x2(10, 1, 200, a, 200, b, 200, c2, 10);

		//f32_seq(c2, 0, 0.2, 100);

		//r_cblas_sgemv(CblasColMajor, CblasNoTrans, 600, 20, 1.f, a, 600, b, 1L, 0.0f, c2, 1L);

		//int m = 1000;
		//int r = 1;
		//res = F77__CALL(RSDOT)(&m, a, &r, b, &r);
		//idx = f32_minidx(b, 5000, &res);

		// avx2_f32_findindex_le(a, c2, .1, 1000);


		//gen_f32_scatter_vec_byindex(a, c1, b, 200);
		//gen_f32_gather2Vec_scatterVal_byindex(a, c2, c1, b, 0.2, 201);
		//avx2_f32_memcpy(a, b, 10000);

	}
	I64 t2 = toc();

	for (int i = 0; i < 40; i++) {
		//	r_printf("%d %d \n", A[i], B[i]);
		 //r_printf("%.8f %.8f  |%.8f\n", c1[i], c2[i], c1[i]-c2[i]);
		r_printf("%d %d  |%d\n", c1[i], c2[i], c1[i] - c2[i]);
	}
	r_printf("\nMat %f, %f: %f\n", (F64)t1, (F64)t2, (F64)t1 / t2);
	r_printf("\nMat %f, %f: %f\n", (F64)t1, (F64)t2, (F64)t1 / t2);


	pcg_set_seed(333, 0);

	tic();
	M = 2000;
	for (int i = 10; i < 1000; i++)	pcg_gauss(a, M);
	t1 = toc();

 
	/*
	I32 A[5500];
	I32 B[5500];
	local_pcg32_random_t rng;

	SetupPCG_AVX2();
	local_pcg_set_seed(&rng, 333, 10);
	local_pcg_random(&rng, A, 500);
	SetupPCG_AVX512();
	local_pcg_set_seed(&rng, 333, 10);
	local_pcg_random(&rng, B, 500);

	//tic();
	//for (int i = 10; i < 1000; i++)
	//	local_pcg_gauss(&rng,a, M);
	//t2 = toc();

	for (int i = 0; i < 49; i++) {
		r_printf("%15u %15u  %u\n", A[i], B[i], B[i]- A[i]);
	}
	*/
 
 
}


void * mainFunction(void *prhs[], int nrhs) {

 
	
	#if R_INTERFACE==1 &&  defined(MSVC_COMPILER)
		SEXP tmp, e;
		ParseStatus status;
		PROTECT(tmp = mkString(R_FUNC));
		PROTECT(e = R_ParseVector(tmp, 1, &status, R_NilValue));
		//R_tryEval(VECTOR_ELT(e, 0), R_GlobalEnv, NULL);
		UNPROTECT(2);
		//TestCode();
	#endif
		
		/*
		int dsvd(double a[][3], int m, int n, double* w, double v[][3]);

		F64PTR dat = GetData(prhs[0]);
		int ROW = 3;
		int COL = 3;
		F64 A[12];
		for (int i = 0; i < ROW * COL; i++) {
			A[i] = dat[i];
		}
		F64 w[3];
		F64 v[3 * 3];
		dsvd(A, ROW,  COL,  w,  v);
		for (int i = 0; i < ROW * COL; i++) {
			r_printf("%f| ", A[i]);
		}
		r_printf("\n\n ");
		for (int i = 0; i <  COL; i++) {
			r_printf("%f| ", w[i]);
		}
		r_printf("\n\n ");
		for (int i = 0; i < COL*COL; i++) {
			r_printf("%f| ", v[i]);
		}

		return IDE_NULL;
	*/
#if !defined(SOLARIS_COMPILER) && defined(TARGET_64) && !defined(ARM64_OS)
		if (nrhs >= 7) {

			int avxOption = GetScalar(prhs[nrhs - 1]);
			if (avxOption == 1) {
				SetupVectorFunction_Generic();
				SetupPCG_GENERIC();
			}
			else if (avxOption == 2) {
				SetupVectorFunction_AVX2();
				SetupPCG_AVX2();
			}
			else if (avxOption == 3) {
				SetupVectorFunction_AVX512();
				SetupPCG_AVX512();
			}
			else {
				SetupRoutinesByCPU();
			}
		}
		else {
			SetupRoutinesByCPU();
		}
#else
		//for SOaris system or Win32
		SetupVectorFunction_Generic();
		SetupPCG_GENERIC();
#endif

		//SetupVectorFunction_Generic();
		//SetupPCG_GENERIC();
	 	
		//print_funcs();


	//r_printf("\033[1m\033[32m" "\033[4m" "%cERROR: Essential input paramaters are missing!\n",149);
	if (nrhs == 0 ) 	{
		r_error("ERROR: Essential input paramaters are missing!\n");
		return IDE_NULL;
	}
	if ( !IsChar(prhs[0]) )	{
		r_error("ERROR: The very first parameter must be a string specifying the algorithm name!\n");
		return IDE_NULL;
	}

	/*
	int i, rc;
	long t1 = 1, t2 = 2, t3 = 3;
	pthread_t      threads[3];
	pthread_attr_t attr;


	pthread_mutex_init(&count_mutex, NULL); //Initialize mutex and condition variable objects
	pthread_cond_init(&count_threshold_cv, NULL);

	// For portability, explicitly create threads in a joinable state 
	pthread_attr_init(&attr);
	pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_JOINABLE);
	pthread_create(&threads[0], &attr, watch_count, (void *)t1);
	pthread_create(&threads[1], &attr, inc_count, (void *)t2);
	pthread_create(&threads[2], &attr, inc_count, (void *)t3);

	//Wait for all threads to complete
	for (i = 0; i<NUM_THREADS; i++) {
	pthread_join(threads[i], NULL);
	}
	printf("Main(): Waited on %d  threads. Done.\n", NUM_THREADS);


	//Clean up and exit
	pthread_join(threads[i], NULL);
	pthread_attr_destroy(&attr);
	pthread_mutex_destroy(&count_mutex);
	pthread_cond_destroy(&count_threshold_cv);
	pthread_exit(NULL);
	return;
	*/
	//F32PTR T = mxGetData(prhs[0]);
	//F32PTR Y = mxGetData(prhs[1]);

	//I32  N        = max(mxGetM(prhs[0]), mxGetN(prhs[0]));

	//chol_full(A, U, N, N);
	//pack_chol_update(x, U1, N);
	//inplace_chol_addCol(A,  N, 1, N);
	//pack_chol(B, U1, N);	
	//pack_chol(B, U, N);
	//pack_solve_L(U, x, N);
	//pack_solve_U(U, x, N);

	//memcpy(data.L2.Y, data.L0.Y, sizeof(F32)*data.L1.n);
	//memcpy(data.Y0.Y, data.L0.Y, sizeof(F32)*data.L1.n);

	//plhs[0] = mxCreateNumericMatrix(data.S.KMAX, N, mxSINGLE_CLASS, mxREAL);
	//F32PTR O1 = mxGetData(plhs[0]);

	//U: col (1, N-w) row(1+w, N)

	/*
	data.L4.sKnot[0] = 101, data.L4.sKnot[1] = 201, data.L4.sKnot[2] = 301;
	data.L4.tKnot[0] = 101, data.L4.tKnot[1] = 201, data.L4.tKnot[2] = 301;

	data.L4.sOrder[0] = 2, data.L4.sOrder[1] = 1, data.L4.sOrder[2] = 3;
	data.L4.tOrder[0] = 2, data.L4.tOrder[1] = 2, data.L4.tOrder[2] = 2;
	data.L4.sNum = 2;
	data.L4.tNum = 2;
	*/

	//get_U_s_e(&data, 1, data.n, 4, 1);
	//memcpy(O1, data.L2.Y, sizeof(F32)*N);

	//F32  bestRSS;

	//memcpy(O1, data.L2.Y, sizeof(F32)* 300);	
	//memcpy(O1, data.RSS_segSplitting, sizeof(F32)* 300);	
	//memcpy(O1, knot.XtY, sizeof(F32)* 17);
	//MEM.free_all(&MEM);
	//return;

 
	/*
	struct TinyTIFFReaderFile* tiffr = TIFF_open("G:\\land\\ndvi\\LT05_018033_19840327.2001-07-14.tif");
	if (!tiffr) 
		printf("XXX\n");	
	else {
		uint32_t width = TIFF_getWidth(tiffr);
		uint32_t height = TIFF_getHeight(tiffr);
		uint16_t* image = (uint16_t*)calloc(width*height, sizeof(double));
		TIFF_getSampleData(tiffr, image, 0);
		///////////////////////////////////////////////////////////////////
		// HERE WE CAN DO SOMETHING WITH THE IMAGE IN image (ROW-MAJOR!)
		///////////////////////////////////////////////////////////////////
		free(image);
	}
	TIFF_close(tiffr);
	return;
	*/
	 

	//mexCallMATLAB(0, NULL, 2, prhs, "fprintf");

	#define STRING_LEN 20

	char  algorithm[STRING_LEN +1];
	GetCharArray(prhs[0], algorithm, STRING_LEN);

	// Now 'algorithm' should be eitehr the default algorith or the value from Opt.

	void * ANS  = NULL;
	int    nptr = 0;
	if      (IS_STRING_EQUAL(algorithm, "beastv4Demo"))
	{
		//BEAST2_OPTIONS    option = {0,}; 
		BEAST2_OPTIONS      option = { {{0,},}, }; //Warning from MacOS: suggest braces around initialization of subobject [-Wmissing-braces]
		option.io.out.result	 = NULL;		// result to be allocated in OUput_allocMEM
		GLOBAL_OPTIONS           = (BEAST2_OPTIONS_PTR)&option;
				
		if ( BEAST2_GetArgs(prhs,nrhs,&option) ==0 ) {
			BEAST2_DeallocateTimeSeriesIO(&(option.io));
			return IDE_NULL;
		}
		
		#ifdef WIN64_OS
			option.extra.computeCredible = TRUE;
			ANS = PROTECT(BEAST2_Output_AllocMEM(&option)); nptr++;
			
			void DllExport BEAST2_WinMain(VOID_PTR  option);

			BEAST2_WinMain((BEAST2_OPTIONS_PTR)GLOBAL_OPTIONS);
		#else
			r_printf("WARNING: The GUI interface is supporte only on the Windows 64 operating system.\n");
		#endif	

		BEAST2_DeallocateTimeSeriesIO(&(option.io));

	}
	else if (IS_STRING_EQUAL(algorithm, "beastv4"))
	{
		/*
		// Initialize mutex and condition variable objects
		pthread_mutex_init(&MUTEX_WRITE, NULL);
		pthread_cond_init(&CONDITION_WRITE, NULL);
		pthread_attr_init(&attr);
		pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_JOINABLE);

		DATA_AVAILABLE_WRITE = false;
		pthread_create(&THREADID_WRITE, &attr, WRITE, (VOID_PTR )&threadParWrite);
		pthread_attr_destroy(&attr); 	
		*/

		/**********************************/
	    //stackoverflow.com/questions/10828294/c-and-c-partial-initialization-of-automatic-structure
	    //stackoverflow.com/questions/11152160/initializing-a-struct-to-0
		//BEAST2_OPTIONS      option = {0,};		
		BEAST2_OPTIONS      option = { {{0,},}, }; //Warning from MacOS: suggest braces around initialization of subobject [-Wmissing-braces]
	
		if (BEAST2_GetArgs(prhs, nrhs, &option) == 0) {
			BEAST2_DeallocateTimeSeriesIO(&(option.io));
			return IDE_NULL;
		}		
		
		option.io.out.result		 = NULL;		 	// result to be allocated in OUput_allocMEM

		if (option.io.q == 1) {
			ANS = PROTECT(BEAST2_Output_AllocMEM(&option)); nptr++;	
		} else {			
			//memset(&option.extra, 0, sizeof(option.extra));
			option.extra.computeSeasonAmp = 0;
			option.extra.computeTrendSlope = 0;
			option.extra.tallyIncDecTrendJump= 0;
			option.extra.tallyPosNegTrendJump = 0;
			option.extra.tallyPosNegOutliers = 0;
			option.extra.tallyPosNegSeasonJump = 0;
	  
	 
			option.extra.computeTrendChngpt = 1;
			option.extra.computeSeasonChngpt = 1;
			//option.extra.computeOutlierChngpt = 1;
			BEAST2_print_options(&option); 
			ANS = PROTECT(BEAST2_Output_AllocMEM(&option)); nptr++;
		}
		
		/**********************************/
	
		GLOBAL_OPTIONS = (BEAST2_OPTIONS_PTR)&option;
		if (option.io.numOfPixels ==1) {
			beast2_main_corev4();
			BEAST2_DeallocateTimeSeriesIO(&(option.io));
			r_printf("\n");
		} else {
			/**********************************/
			I32 NUM_THREADS			= option.extra.numParThreads;  // I32 NUM_CORES_TOUSE= option.extra.numCPUCoresToUse;;			
			I32 NUM_CORES			= GetNumCores();
			I32 NUM_THREADS_PER_CPU = option.extra.numThreadsPerCPU;

			NUM_CORES			= max(NUM_CORES, 1L);			
			NUM_THREADS_PER_CPU = max(NUM_THREADS_PER_CPU, 1L);
			
			NUM_THREADS = (NUM_THREADS <= 0) ? NUM_CORES * NUM_THREADS_PER_CPU : NUM_THREADS;
			NUM_THREADS = min(NUM_THREADS, option.io.numOfPixels);
			/**********************************/
			NUM_OF_PROCESSED_PIXELS		 = 0;
			NUM_OF_PROCESSED_GOOD_PIXELS	 = 0;
			NEXT_PIXEL_INDEX			 = 1;

			/**********************************/
			pthread_mutex_init(&mutex, NULL); //Initialize mutex and condition variable objects
			pthread_cond_init(&condVar, NULL);
			/**********************************/

			/**********************************/
			// For portability, explicitly create threads in a joinable state 
			pthread_attr_t attr;
			pthread_attr_init(&attr);
			pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_JOINABLE);
			/**********************************/

			thread_id = malloc(sizeof(pthread_t) * NUM_THREADS); // threadID is a global variable.
			extern int beast2_main_corev4_mthrd(void* dummy);
			for (I32 i = 0; i < NUM_THREADS; i++) {
             #if defined(LINUX_OS) || defined (WIN32_OS) || defined (WIN64_OS) 
				cpu_set_t cpuset;
				CPU_ZERO(&cpuset);
				CPU_SET(i, &cpuset);
				//https://stackoverflow.com/questions/25472441/pthread-affinity-before-create-threads
				pthread_attr_setaffinity_np(&attr, sizeof(cpu_set_t), &cpuset);
				pthread_create(&thread_id[i], &attr, beast2_main_corev4_mthrd, (void*)NULL);
				//https://stackoverflow.com/questions/1407786/how-to-set-cpu-affinity-of-a-particular-pthread
				//sched_setaffinity(thread_id[i], sizeof(cpuset), &cpuset)
			 #elif defined(MAC_OS)
				cpu_set_t cpuset;
				CPU_ZERO(&cpuset);
				CPU_SET(i, &cpuset);
				//https://stackoverflow.com/questions/25472441/pthread-affinity-before-create-threads			
				pthread_create(&thread_id[i], &attr, beast2_main_corev4_mthrd, (void*)NULL);
				pthread_setaffinity_np(thread_id[i], sizeof(cpu_set_t), &cpuset);
		     #elif defined (SOLARIS_OS)
				cpu_set_t cpuset;
				CPU_ZERO(&cpuset);
				CPU_SET(i, &cpuset);
				//https://stackoverflow.com/questions/25472441/pthread-affinity-before-create-threads			
				pthread_create(&thread_id[i], &attr, beast2_main_corev4_mthrd, (void*)NULL);
				sched_getaffinity(thread_id[i], sizeof(cpu_set_t), &cpuset);
			 #else
				pthread_create(&thread_id[i], &attr, beast2_main_corev4_mthrd, (void*)NULL);
			 #endif
				r_printf("Parallel computing: thread#%-d generated ... \n", i+1);
			}
			r_printf("Rbeast: Waiting on %d threads...\n", NUM_THREADS);
			pthread_attr_destroy(&attr);


			IDE_USER_INTERRUPT = 0;
			#if R_INTERACE==1
				r_printf("Press and hold the ESCAPE key or the STOP button to interrupt and quit while running.\n" );
			#elif M_INTERFACE==1
				r_printf("Press and hold CTR+C to interrupt and quit while running.\n");
			#endif

			if (option.extra.printProgressBar) {
				// Print a blank line to be backspaced by the follow
				void* BUF         = malloc(option.extra.consoleWidth * 3);
				PERCENT_COMPLETED = 0;
				REMAINING_TIME    = 10000;
				printProgress2(PERCENT_COMPLETED, REMAINING_TIME, option.extra.consoleWidth, BUF, 1);				
				// https://www.mathworks.com/matlabcentral/answers/101658-is-it-possible-to-start-new-threads-from-a-c-mex-file
				// https://stackoverflow.com/questions/28227313/multithreaded-pthreads-matlab-mex-function-causes-matlab-to-crash-after-exitin
				// https://stackoverflow.com/questions/54010898/how-do-you-print-to-console-in-a-multi-threaded-mex-function
				while (PERCENT_COMPLETED < 1.f && NEXT_PIXEL_INDEX < option.io.numOfPixels && IDE_USER_INTERRUPT==0) {
					printProgress2(PERCENT_COMPLETED, REMAINING_TIME, option.extra.consoleWidth, BUF, 0);
					Sleep_ms(2 * 1000);
					 
					if (CheckInterrupt()) {
						ConsumeInterruptSignal();// only needed for Matlab
						IDE_USER_INTERRUPT = 1;
						r_printf("Quitting due to unexpected user interruption...\n");
					}
					 
				}

				if (IDE_USER_INTERRUPT == 0) printProgress2(1.0, 0, option.extra.consoleWidth, BUF, 0);
				r_printf("\n");
				free(BUF);
			}  

			// Wait for all threads to complete
			for (I32 i = 0; i < NUM_THREADS; i++) {
				//pthread_join(thread_id[i], NULL);
				I64 ret=0;
				pthread_join(thread_id[i], &ret);
				//r_printf("\nstack size %d.\n", ret/1024/1024);
			}
			if (IDE_USER_INTERRUPT==0)
				r_printf("\nRbeast: Waited on %d threads. Done.\n", NUM_THREADS);
			else
				r_printf("\nQuited unexpected upon the user's interruption.\n");

			//Clean up and exit		
			pthread_mutex_destroy(&mutex);
			pthread_cond_destroy(&condVar);
			//pthread_exit(NULL);	
			free(thread_id);
			 
			BEAST2_DeallocateTimeSeriesIO(&(option.io));
		}
		
 
	}
	#if !defined(R_RELEASE)
	else if  (IS_STRING_EQUAL(algorithm, "mrbeast"))
	{
		MV_OPTIONS         option;
		MV_IO              io;
		MV_RESULT          result;
		memset(&io,     0, sizeof(MV_IO));
		memset(&result, 0, sizeof(MV_RESULT));
	 
		option.io               = &io;
		option.io->out.result   = &result;
		option.io->isRegularOrdered  = 1;
		
		if (!MV_Get1stArg_Data(prhs, nrhs, &option)     ||
			!MV_Get2ndArg_MetaData(prhs, nrhs, &option) ||
			!MV_Get3rdArg_Prior(prhs, nrhs, &option) ||
			!MV_Get4thArg_MCMC(prhs, nrhs, &option) ||
			!MV_Get5thArg_FLAGS(prhs, nrhs, &option)) {
			return IDE_NULL;
		}

		MV_print_options(&option);
		ANS = PROTECT(MV_AllocateOutput(&option)); nptr++;

		GLOBAL_OPTIONS = (MV_OPTIONS_PTR)&option;
		mrbeast_main_core();
		MV_DeallocateTimeSeriesIO(option.io);
	} 
	#endif
	else if (IS_STRING_EQUAL(algorithm, "tsextract")) {
		extern void* BEAST2_TsExtract(void* o, void* pindex);

		//prhs[o] is "tsextract"
		ANS = PROTECT(BEAST2_TsExtract(prhs[1], prhs[2]));
		nptr++;
	}
	else if (IS_STRING_EQUAL(algorithm, "print")) {
		extern void* BEAST2_PrintResult(void* o, void* pindex);
		//prhs[o] is "tsextract"
		BEAST2_PrintResult(prhs[1], prhs[2]); 
	}
	
	/*
		// Initialize mutex and condition variable objects
		pthread_mutex_init(&MUTEX_WRITE, NULL);
		pthread_cond_init(&CONDITION_WRITE, NULL);
		pthread_attr_init(&attr);
		pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_JOINABLE);

		DATA_AVAILABLE_WRITE = false;
		pthread_create(&THREADID_WRITE, &attr, WRITE, (VOID_PTR )&threadParWrite);
		pthread_attr_destroy(&attr); 	
	*/
	/*
	else if (IS_STRING_EQUAL(algorithm, "beastMT"))
	{
	

		BEAST_OPTIONS         option;
		BEAST_IO              io;
		BEAST_RESULT          result;
		memset(&io,     0, sizeof(BEAST_IO));
		memset(&result, 0, sizeof(BEAST_RESULT));
		option.io = &io;
		option.io->out.result  = &result;
		option.io->isRegularOrdered = 1;


		if (!BEAST_Get1stArg_Data(prhs, nrhs, &option) ||
			!BEAST_Get2ndArg_MetaData(prhs, nrhs, &option) ||
			!BEAST_Get3rdArg_Prior(prhs, nrhs, &option) ||
			!BEAST_Get4thArg_MCMC(prhs, nrhs, &option) ||
			!BEAST_Get5thArg_FLAGS(prhs, nrhs, &option)) {
			return NULL;
		}

		BEAST_print_options(&option);
		ANS = PROTECT(BEAST_AllocateOutput(&option)); nptr++;
		GLOBAL_OPTIONS = (BEAST_OPTIONS_PTR)&option;
	 
		
 
		pthread_mutex_init(&mutex, NULL); //Initialize mutex and condition variable objects
		pthread_cond_init(&condVar, NULL);

		// For portability, explicitly create threads in a joinable state 
		pthread_attr_t attr;
		pthread_attr_init(&attr);
		pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_JOINABLE);
 
		cpu_set_t cpus;

		
		I32 NUM_THREADS;

		I32 nCores   = GetNumCores();
		nCores       = max(nCores, 1);

		NUM_THREADS  = option.extra.numCPUCoresToUse;
		if (NUM_THREADS == 0) {
			NUM_THREADS = nCores - 1;
		} else if (NUM_THREADS < 0)	{
			NUM_THREADS = nCores + NUM_THREADS;
		}
		NUM_THREADS = min(nCores- 1, NUM_THREADS);
		NUM_THREADS = max(NUM_THREADS, 1);
		NUM_THREADS = min(NUM_THREADS, option.io->numOfPixels);	

		thread_id    = malloc(sizeof(pthread_t) * NUM_THREADS);

		NEXT_PIXEL_INDEX = 1;
		for (I32 i = 0; i < NUM_THREADS; i++) 	{	
			 CPU_ZERO(&cpus);
			 CPU_SET(i, &cpus);
			 pthread_attr_setaffinity_np(&attr, sizeof(cpu_set_t), &cpus);

			 extern 	int beast_main_mthrd(void *);
			 pthread_create(&thread_id[i], &attr, beast_main_mthrd, (void *)NULL);
		}
		pthread_attr_destroy(&attr);

		if (option.extra.printProgressBar) {
			// Print a blank line to be backspaced by the follow
			void* BUF;
			BUF = malloc(option.extra.consoleWidth * 3);
			printProgress2(0, 0, option.extra.consoleWidth, BUF, 1);

			PERCENT_COMPLETED = 0;
			REMAINING_TIME    = 10000;
			// https://www.mathworks.com/matlabcentral/answers/101658-is-it-possible-to-start-new-threads-from-a-c-mex-file
			// https://stackoverflow.com/questions/28227313/multithreaded-pthreads-matlab-mex-function-causes-matlab-to-crash-after-exitin
			// https://stackoverflow.com/questions/54010898/how-do-you-print-to-console-in-a-multi-threaded-mex-function
			while (PERCENT_COMPLETED < 1.f && NEXT_PIXEL_INDEX < option.io->numOfPixels) {			
				printProgress2(PERCENT_COMPLETED, REMAINING_TIME, option.extra.consoleWidth, BUF, 0);
				Sleep_ms(2 * 1000);
			}
			printProgress2(1.0, 0, option.extra.consoleWidth, BUF, 0);
			free(BUF);
		} else	{
			r_printf("\nRbeast: Waiting on %d threads...\n", NUM_THREADS);
		}


		// Wait for all threads to complete
		for (I32 i = 0; i<NUM_THREADS; i++) {
			pthread_join(thread_id[i], NULL);
		}
		r_printf("\nRbeast: Waited on %d threads. Done.\n", NUM_THREADS);

		//Clean up and exit		
		pthread_mutex_destroy(&mutex);
		pthread_cond_destroy(&condVar);
		//pthread_exit(NULL);	
		free(thread_id);
	}
	 */

 
	//else if (IS_STRING_EQUAL(algorithm, "SBM_ST"))			//SBM_ST(nlhs, plhs, nrhs, prhs);	
 	//else if (IS_STRING_EQUAL(algorithm, "SBM_ST_BIC"))  	//SBM_ST_BIC(nlhs, plhs, nrhs, prhs);
	
 /*
	else if (IS_STRING_EQUAL(algorithm, "SLIDE"))
	{
		SOptions beastOption;  GLOBAL_OPTIONS = &beastOption;
		SRESULT  result;       GLOBAL_RESULT  = &result;
		char missing[50];
		if (!SF_check_input(nrhs, prhs) ||
			!SF_read_input(&beastOption, nrhs, prhs, missing) ||
			!SF_check_options(&beastOption, missing)
			)
		{
			return;
		}

		//print_options(&beastOption);
		////plhs[0] = SF_allocate_output(&result, &beastOption);
		sbmfast_slide();
	} 
 
	else if (IS_STRING_EQUAL(algorithm, "QR"))
	{
		SOptions beastOption;  GLOBAL_OPTIONS = &beastOption;
		SRESULT  result;       GLOBAL_RESULT = &result;
		char missing[300];
		if (!SF_check_input(nrhs, prhs) ||
			!SF_read_input(&beastOption, nrhs, prhs,  missing) ||
			!SF_check_options(&beastOption,  missing)
			)
		{
			return;
		}

		//print_options(&beastOption);
		////plhs[0] = SF_allocate_output(&result, &beastOption);
		sbmfast_slide_robust();
	}
	else if (IS_STRING_EQUAL(algorithm, "SWEEP"))
	{
		SOptions beastOption;  GLOBAL_OPTIONS = &beastOption;
		SRESULT  result;       GLOBAL_RESULT = &result;
		char missing[300];
		if (!SF_check_input(nrhs, prhs) ||
			!SF_read_input(&beastOption, nrhs, prhs,  missing) ||
			!SF_check_options(&beastOption,  missing)
			)
		{
			return;
		}

		//print_options(&beastOption);
		////plhs[0] = SF_allocate_output(&result, &beastOption);
		sbmfast_sweep();
	}
 */
	/*
	else if (strcicmp( algName, "sbm") == 0)
	{
	OPTIONS beastOption;
	RESULT  result;
	GLOBAL_OPTIONS = (OPTIONS_PTR)&beastOption;
	GLOBAL_RESULT = (RESULT_PTR)&result;

	if (!M_sbm_check_input(nrhs, prhs) ||
	!M_sbm_read_input(&beastOption, nrhs, prhs,  missing) ||
	!check_options(&beastOption,  missing)
	)
	{
	return;
	}

	print_options(&beastOption);
	plhs[0] = M_sbm_allocate_output(&result, &beastOption);
	sbm();
	}
	*/
	
 
	UNPROTECT(nptr);

	return ANS == NULL ? IDE_NULL : ANS;	
}
 

#if R_INTERFACE==1
#include <R_ext/libextern.h>
#include "Rembedded.h"

//	R_FlushConsole(): a R functin to flush the print
#if defined(MSVC_COMPILER)
SEXP DllExport rexFunction1(SEXP rList, SEXP dummy)
#else
SEXP DllExport rexFunction(SEXP rList, SEXP dummy)
#endif
{
  	
 /*
	FILELIST_PTR flist = GetFlist("a:\\", "tif");
	PrintFlist(flist);
	FreeFlist(flist);
	return R_NilValue;
	
	SEXP IMG = R_NilValue;
 
	struct TinyTIFFReaderFile* tiffr = TIFF_open("a:\\landsat_postfire_2012.tif");
	//tiffr = TIFF_open("G:\\land\\ndvi\\LT05_018033_19840327.2001-07-14.tif");
	
	if (!tiffr) {
		printf("XXX\n");
		return IMG;
	}
	
	TIFF_readIFD(tiffr, 0);
	TIFF_getCurrentFrameInfo(tiffr);

	uint32_t width  = TIFF_getWidth(tiffr);
	uint32_t height = TIFF_getHeight(tiffr);
	double* image   = (uint16_t*)malloc(width*height*sizeof(double));

	int sample = GetScalar(VECTOR_ELT(rList, 0));

	TIFF_getSampleData(tiffr, image, sample);
	TIFF_close(tiffr);
	
	///////////////////////////////////////////////////////////////////
	// HERE WE CAN DO SOMETHING WITH THE IMAGE IN image (ROW-MAJOR!)
	///////////////////////////////////////////////////////////////////
	IMG = PROTECT(Rf_allocMatrix(REALSXP, width, height));
	//IMG = PROTECT(Rf_alloc3DArray(REALSXP, width, height, 6));
	double *tmp=REAL(IMG);
	for (I32 i = 0; i < height*width; i++)
		tmp[i] = *((double*)image + i);
	free(image);
	UNPROTECT(1);
	return IMG; 
 */

	if (!isNewList(rList)) 	return R_NilValue;
 
	// stat.ethz.ch/pipermail/r-help/2001-September/015081.html
	//SEXP   prhs = VECTOR_DATA(inList);
	SEXP   prhs[10];
	int    nrhs = length(rList);
	nrhs = min(10L, nrhs);
	for (int i = 0; i < nrhs; i++) 	
		prhs[i] = VECTOR_ELT(rList, i);

	SEXP ans;
	PROTECT(ans=mainFunction(prhs, nrhs));
	UNPROTECT(1);
	return ans != NULL ? ans : R_NilValue;
}


#define CALLDEF(name, n) {#name, (DL_FUNC) &name, n}


#if (defined(WIN64_OS) || defined(WIN32_OS)) 
	SEXP TetrisSetTimer(SEXP action, SEXP seconds, SEXP envior);
	static const R_CallMethodDef CallEntries[] = {
		#if defined(MSVC_COMPILER)
		CALLDEF(rexFunction1,    2),
		#else
		CALLDEF(rexFunction,    2),
		#endif
		CALLDEF(TetrisSetTimer, 3),
		{ NULL, NULL, 0 }
	};
#else
static const R_CallMethodDef CallEntries[] = {
				CALLDEF(rexFunction, 2),
				{ NULL, NULL, 0 }
			};
#endif



void  R_init_Rbeast(DllInfo *dll)
{
	R_registerRoutines(dll, NULL, CallEntries, NULL, NULL);
	R_useDynamicSymbols(dll, FALSE);
	//R_forceSymbols(dll, TRUE);
}

#elif M_INTERFACE ==1

/***************************************************************
* function: mexFunction() - Matlab interface function.         *
* INPUTS:                                                      *
*   nlhs - The number of output variables to be assigned by    *
*     the mex function.                                        *
*   plhs[] - Empty array of MATLAB matricies, of size nlhs.    *
*     This is to be filled in by this application.             *
*   nrhs - Number of input arguments to this mex funciton.     *
*   prhs[] - Array of MATLAB matricies from which input data   *
*     is taken.                                                *
***************************************************************/

#include "abc_date.h"
void DllExport mexFunction(int nlhs, mxArray * _restrict plhs[],   int nrhs, const mxArray * _restrict prhs[]) {
	
	//https://stackoverflow.com/questions/19813718/mex-files-how-to-return-an-already-allocated-matlab-array
	//https://www.mathworks.com/matlabcentral/answers/77048-return-large-unchange-mxarray-from-mex
	//https://stackoverflow.com/questions/18847833/is-it-possible-return-cell-array-that-contains-one-instance-in-several-cells/18849127#18849127
	//https://undocumentedmatlab.com/articles/matlabs-internal-memory-representation/
	// NOT ALWAYS WORK
	//plhs[0] = prhs[0];
	//mxCreateSharedDataCopy
	
	mxArray * ans = mainFunction(prhs, nrhs);
	plhs[0] = ans;
	return;

 
	/*
 	long t1 = 1, t2 = 2, t3 = 3;
	pthread_t      threads[3];
	pthread_attr_t attr;

	pthread_mutex_init(&count_mutex, NULL); //Initialize mutex and condition variable objects
	pthread_cond_init(&count_threshold_cv, NULL);

	// For portability, explicitly create threads in a joinable state
	pthread_attr_init(&attr);
	pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_JOINABLE);
	pthread_create(&threads[0], &attr, watch_count, (void *)t1);
	pthread_create(&threads[1], &attr, inc_count, (void *)t2);
	pthread_create(&threads[2], &attr, inc_count, (void *)t3);

	//Wait for all threads to complete
	for (int i = 0; i<NUM_THREADS; i++) {
	pthread_join(threads[i], NULL);
	}
	printf("Main(): Waited on %d  threads. Done.\n", NUM_THREADS);

	//Clean up and exit
	pthread_attr_destroy(&attr);
	pthread_mutex_destroy(&count_mutex);
	pthread_cond_destroy(&count_threshold_cv);
	pthread_exit(NULL);
	return;
	*/

	//F32PTR T = mxGetData(prhs[0]);
	//F32PTR Y = mxGetData(prhs[1]);

	//I32  N        = max(mxGetM(prhs[0]), mxGetN(prhs[0]));

	//chol_full(A, U, N, N);
	//pack_chol_update(x, U1, N);
	//inplace_chol_addCol(A,  N, 1, N);
	//pack_chol(B, U1, N);	
	//pack_chol(B, U, N);
	//pack_solve_L(U, x, N);
	//pack_solve_U(U, x, N);

	//memcpy(data.L2.Y, data.L0.Y, sizeof(F32)*data.L1.n);
	//memcpy(data.Y0.Y, data.L0.Y, sizeof(F32)*data.L1.n);

	//plhs[0] = mxCreateNumericMatrix(data.S.KMAX, N, mxSINGLE_CLASS, mxREAL);
	//F32PTR O1 = mxGetData(plhs[0]);

	//U: col (1, N-w) row(1+w, N)

	/*
	data.L4.sKnot[0] = 101, data.L4.sKnot[1] = 201, data.L4.sKnot[2] = 301;
	data.L4.tKnot[0] = 101, data.L4.tKnot[1] = 201, data.L4.tKnot[2] = 301;

	data.L4.sOrder[0] = 2, data.L4.sOrder[1] = 1, data.L4.sOrder[2] = 3;
	data.L4.tOrder[0] = 2, data.L4.tOrder[1] = 2, data.L4.tOrder[2] = 2;
	data.L4.sNum = 2;
	data.L4.tNum = 2;
	*/

	//get_U_s_e(&data, 1, data.n, 4, 1);
	//memcpy(O1, data.L2.Y, sizeof(F32)*N);

	//F32  bestRSS;

	//memcpy(O1, data.L2.Y, sizeof(F32)* 300);	
	//memcpy(O1, data.RSS_segSplitting, sizeof(F32)* 300);	
	//memcpy(O1, knot.XtY, sizeof(F32)* 17);
	//MEM.free_all(&MEM);
	//return;


	/*
	struct TinyTIFFReaderFile* tiffr = NULL;
	tiffr = TIFF_open("G:\\land\\ndvi\\LT05_018033_19840327.2001-07-14.tif");
	if (!tiffr) {
	printf("XXX\n");
	}
	else {
	uint32_t width = TIFF_getWidth(tiffr);
	uint32_t height = TIFF_getHeight(tiffr);
	uint16_t* image = (uint16_t*)calloc(width*height, sizeof(double));
	TIFF_getSampleData(tiffr, image, 0);

	///////////////////////////////////////////////////////////////////
	// HERE WE CAN DO SOMETHING WITH THE IMAGE IN image (ROW-MAJOR!)
	///////////////////////////////////////////////////////////////////

	free(image);

	}
	TIFF_close(tiffr);
	return;

	mexCallMATLAB(0, NULL, 2, prhs, "fprintf");

	*/



}
#endif

#if R_INTERFACE==11111111111111

SEXP DllExport sbm2(SEXP Y, SEXP opt)
{
	if (!R_sbm_check_input(Y, opt))		 			return R_NilValue;

	char	missing[31];
	BEAST_OPTIONS beastOption;

	R_sbm_read_input(&beastOption, Y, opt, missing);

	if (!sbm_check_options(&beastOption, missing))	return R_NilValue;
	print_options(&beastOption);

	BEAST_RESULT	result;
	SEXP	ANS;
	PROTECT(ANS = R_allocate_output(&result, &beastOption));

	GLOBAL_OPTIONS = (BEAST_OPTIONS_PTR)&beastOption;
	GLOBAL_RESULT = (BEAST_RESULT_PTR)&result;
	sbm();
		UNPROTECT(1);
	return ANS;
}
#endif
 
/*
#define NUM_THREADS  3
#define TCOUNT 10
#define COUNT_LIMIT 12

int     count = 0;
int     thread_ids[3] = { 0, 1, 2 };
pthread_mutex_t count_mutex;
pthread_cond_t  count_threshold_cv;

void *inc_count(void *t)
{


	int i;
	long my_id = (long)t;

	for (i = 0; i<TCOUNT; i++) {
		pthread_mutex_lock(&count_mutex);
		count++;

		
		//Check the value of count and signal waiting thread when condition is
		//reached.  Note that this occurs while mutex is locked.
		
		if (count == COUNT_LIMIT) {
			pthread_cond_signal(&count_threshold_cv);
			printf("inc_count(): thread %ld, count = %d  Threshold reached.\n",
				my_id, count);
		}
		printf("inc_count(): thread %ld, count = %d, unlocking mutex\n",
			my_id, count);
		pthread_mutex_unlock(&count_mutex);

		// Do some "work" so threads can alternate on mutex lock 
		_sleep(1);
	}
	pthread_exit(NULL);
}

void *watch_count(void *t)
{
	long my_id = (long)t;

	printf("Starting watch_count(): thread %ld\n", my_id);

	
	//Lock mutex and wait for signal.  Note that the pthread_cond_wait
	//routine will automatically and atomically unlock mutex while it waits.
	//Also, note that if COUNT_LIMIT is reached before this routine is run by
	//the waiting thread, the loop will be skipped to prevent pthread_cond_wait
	//from never returning.
	
	pthread_mutex_lock(&count_mutex);
	while (count<COUNT_LIMIT) {
		pthread_cond_wait(&count_threshold_cv, &count_mutex);
		printf("watch_count(): thread %ld Condition signal received.\n", my_id);
	}
	count += 125;
	printf("watch_count(): thread %ld count now = %d.\n", my_id, count);
	pthread_mutex_unlock(&count_mutex);
	pthread_exit(NULL);
}
*/

#include "abc_000_warning.h"